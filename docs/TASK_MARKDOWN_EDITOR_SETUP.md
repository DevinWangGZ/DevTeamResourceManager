# 任务Markdown编辑器功能实现说明

> **实现日期**：2024-12 | **状态**：已完成

## 一、功能概述

已实现任务创建页面的Markdown编辑器功能，包括：

1. ✅ 任务创建从弹窗改为独立页面
2. ✅ Markdown编辑器集成（md-editor-v3）
3. ✅ 图片上传功能（粘贴、拖拽、点击上传）
4. ✅ 实时预览功能
5. ✅ 草稿自动保存
6. ✅ 任务详情页Markdown渲染

---

## 二、安装依赖

### 前端依赖

```bash
cd frontend
npm install md-editor-v3 marked highlight.js
```

### 后端依赖

无需额外安装，使用FastAPI内置功能。

---

## 三、文件结构

### 前端文件

```
frontend/src/
├── api/
│   └── upload.ts                    # 图片上传API（新建）
├── components/
│   ├── business/
│   │   └── MarkdownEditor.vue       # Markdown编辑器组件（新建）
│   └── ui/
│       └── MarkdownViewer.vue       # Markdown渲染组件（新建）
├── views/
│   ├── TaskCreate.vue               # 任务创建页面（新建）
│   ├── TaskDetail.vue               # 任务详情页（已更新，支持Markdown渲染）
│   └── TaskList.vue                 # 任务列表页（已更新，移除创建弹窗）
└── router/
    └── index.ts                     # 路由配置（已更新，添加创建页面路由）
```

### 后端文件

```
backend/app/
├── api/
│   └── v1/
│       ├── endpoints/
│       │   └── upload.py            # 图片上传API端点（新建）
│       └── router.py                # 路由注册（已更新）
├── main.py                          # 应用入口（已更新，添加静态文件服务）
└── uploads/
    └── images/                      # 图片上传目录（自动创建）
```

---

## 四、功能说明

### 4.1 任务创建页面

**路由**：`/tasks/create`

**功能**：
- 基本信息填写（标题、项目、人天等）
- Markdown编辑器编辑任务描述
- 图片上传（粘贴、拖拽、点击）
- 实时预览
- 草稿自动保存（每30秒）
- 手动保存草稿
- 表单验证

**访问方式**：
- 从任务列表页面点击"创建任务"按钮
- 直接访问 `/tasks/create` 路由

---

### 4.2 Markdown编辑器

**组件**：`MarkdownEditor.vue`

**功能**：
- 支持完整Markdown语法
- 工具栏快捷操作（加粗、斜体、标题、列表等）
- 实时预览（编辑和预览双栏）
- 图片上传集成
- 代码高亮
- 全屏编辑

**支持的Markdown语法**：
- 标题（H1-H6）
- 加粗、斜体、删除线
- 代码行内、代码块
- 有序列表、无序列表
- 链接、图片
- 引用、表格
- 水平线

---

### 4.3 图片上传

**功能**：
- **粘贴上传**：Ctrl+V / Cmd+V 粘贴图片
- **拖拽上传**：拖拽图片文件到编辑器
- **点击上传**：点击工具栏图片按钮
- **自动压缩**：超过2MB的图片自动压缩
- **格式支持**：JPG、PNG、GIF、WebP、SVG
- **大小限制**：单张图片最大5MB

**上传流程**：
1. 用户上传图片
2. 前端验证文件类型和大小
3. 如果超过2MB，自动压缩
4. 上传到后端API
5. 后端保存到 `backend/uploads/images/` 目录
6. 返回图片URL
7. 自动插入到Markdown中

---

### 4.4 草稿保存

**功能**：
- **自动保存**：每30秒自动保存到localStorage
- **手动保存**：点击"保存草稿"按钮
- **草稿加载**：下次进入创建页面时自动提示加载草稿
- **草稿清除**：创建成功后自动清除草稿

**存储位置**：浏览器localStorage（`task_draft`）

---

### 4.5 任务详情页Markdown渲染

**组件**：`MarkdownViewer.vue`

**功能**：
- Markdown文本渲染为HTML
- 代码高亮（highlight.js）
- 样式美化（GitHub风格）
- 响应式布局

---

## 五、API接口

### 5.1 图片上传API

**端点**：`POST /api/v1/upload/image`

**请求**：
- Content-Type: `multipart/form-data`
- Body: `file` (File)

**响应**：
```json
{
  "url": "/uploads/images/xxx.jpg",
  "filename": "xxx.jpg",
  "size": 102400
}
```

**权限**：需要登录

---

## 六、配置说明

### 6.1 静态文件服务

后端已配置静态文件服务，上传的图片可以通过以下URL访问：

```
http://localhost:8000/uploads/images/{filename}
```

### 6.2 上传目录

图片保存在：`backend/uploads/images/`

目录会在首次上传时自动创建。

---

## 七、使用说明

### 7.1 创建任务

1. 访问任务列表页面
2. 点击"创建任务"按钮
3. 填写基本信息
4. 在Markdown编辑器中编写任务描述
5. 可以插入图片、代码块等
6. 实时预览效果
7. 点击"创建任务"提交

### 7.2 插入图片

**方式1：粘贴**
- 复制图片（Ctrl+C / Cmd+C）
- 在编辑器中粘贴（Ctrl+V / Cmd+V）

**方式2：拖拽**
- 拖拽图片文件到编辑器区域

**方式3：点击上传**
- 点击工具栏的图片按钮
- 选择图片文件

### 7.3 查看任务描述

任务详情页会自动渲染Markdown格式的任务描述，包括：
- 格式化的文本
- 代码高亮
- 图片显示
- 表格、列表等

---

## 八、注意事项

### 8.1 依赖安装

**重要**：需要先安装前端依赖才能使用：

```bash
cd frontend
npm install md-editor-v3 marked highlight.js
```

### 8.2 图片存储

- 图片存储在服务器文件系统
- 生产环境建议迁移到对象存储（OSS）
- 需要定期清理未使用的图片

### 8.3 安全性

- 图片上传已做类型和大小验证
- Markdown渲染时已做XSS防护
- 建议在生产环境添加更多安全检查

### 8.4 性能

- 大图片会自动压缩
- 编辑器支持懒加载
- 建议对图片进行CDN加速

---

## 九、后续优化

### 9.1 功能增强

- [ ] 任务描述模板
- [ ] 任务描述历史版本
- [ ] 任务描述导出
- [ ] 协作编辑

### 9.2 性能优化

- [ ] 图片CDN加速
- [ ] 编辑器懒加载
- [ ] 预览虚拟滚动

### 9.3 用户体验

- [ ] 快捷键自定义
- [ ] 主题切换
- [ ] 全屏编辑模式优化

---

## 十、问题排查

### Q1: 编辑器不显示？

**检查**：
1. 是否安装了依赖：`npm install md-editor-v3 marked highlight.js`
2. 浏览器控制台是否有错误
3. 组件是否正确导入

### Q2: 图片上传失败？

**检查**：
1. 后端服务是否运行
2. `backend/uploads/images/` 目录是否存在且有写权限
3. 文件类型和大小是否符合要求
4. 网络请求是否正常

### Q3: Markdown渲染不正确？

**检查**：
1. 是否安装了 `marked` 和 `highlight.js`
2. MarkdownViewer组件是否正确导入
3. 浏览器控制台是否有错误

---

**文档维护**：本文档随功能更新持续维护。
